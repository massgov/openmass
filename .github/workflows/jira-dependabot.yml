name: Jira Dependabot

on:
  pull_request:
    types: [opened, labeled]

env:
  JIRA_API_TOKEN: ${{ secrets.JIRA_API_TOKEN }}

jobs:
  create-jira-ticket:
    if: contains(github.event.pull_request.labels.*.name, 'Dependencies')
    runs-on: ubuntu-latest
    steps:
      - id: fetch-jira-cli
        # https://github.com/actions/runner-images/blob/main/images/ubuntu/Ubuntu2404-Readme.md#homebrew-note
        run: |
          eval "$(/home/linuxbrew/.linuxbrew/bin/brew shellenv)" && \
          brew tap ankitpokhrel/jira-cli && \
          brew install jira-cli
      - id: configure-jira-cli
        run: |
          eval "$(/home/linuxbrew/.linuxbrew/bin/brew shellenv)" && \
          jira init --installation cloud --project DP --board "Mass.gov feature/SSR" --server "https://massgov.atlassian.net" --login "moshe.weitzman@mass.gov"
      - id: create-jira-issue
        run: |
          eval "$(/home/linuxbrew/.linuxbrew/bin/brew shellenv)" && \
          $URL = `/home/linuxbrew/.linuxbrew/bin/brew shellenv && jira issue create -tBug -s"${{ github.event.pull_request.title }}" -yNormal -lDependabot -lb-plat-massgov -Cp-massgov -b"Dependabot has opened a PR to update dependencies. Review and merge the PR ${{ github.event.pull_request.html_url }}"` && \
          echo outputContent=$URL >> $env:GITHUB_OUTPUT
      - id: transition-jira-issue
        run: |
          eval "$(/home/linuxbrew/.linuxbrew/bin/brew shellenv)" && \
          $ID = $(basename ${{ steps.create-jira-issue.outputs.outputContent }}) && \
          jira issue move $ID "Slated"
