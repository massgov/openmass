<?php

/**
 * @file
 * Emoji validation module to prevent emoji characters in text fields.
 */

use Drupal\Core\Entity\EntityTypeInterface;
use Drupal\Core\Entity\EntityInterface;

/**
 * Returns the list of text field types to validate.
 */
function _emoji_validation_text_field_types() {
  return ['text', 'text_long', 'text_with_summary', 'string', 'string_long', 'list_string'];
}

/**
 * Implements hook_entity_base_field_info_alter().
 *
 * Attach NoEmojiConstraint to base fields (node.title, taxonomy_term.name, etc.).
 */
function emoji_validation_entity_base_field_info_alter(&$fields, EntityTypeInterface $entity_type) {
  foreach ($fields as $field_name => $field_definition) {
    if (in_array($field_definition->getType(), _emoji_validation_text_field_types(), TRUE)) {
      $constraints = $field_definition->getConstraints();
      $constraints['NoEmojiConstraint'] = [];
      $field_definition->setConstraints($constraints);
    }
  }
}

/**
 * Implements hook_entity_bundle_field_info_alter().
 *
 * Attach NoEmojiConstraint to custom bundle fields (field_*).
 */
function emoji_validation_entity_bundle_field_info_alter(&$fields, EntityTypeInterface $entity_type, $bundle) {
  foreach ($fields as $field_name => $field_definition) {
    if (in_array($field_definition->getType(), _emoji_validation_text_field_types(), TRUE)) {
      $constraints = $field_definition->getConstraints();
      $constraints['NoEmojiConstraint'] = [];
      $field_definition->setConstraints($constraints);
    }
  }
}

/**
 * Implements hook_entity_presave().
 *
 * Enforce emoji validation before saving any entity.
 * Skips taxonomy terms to allow emojis in labels/tags.
 */
function emoji_validation_entity_presave(EntityInterface $entity) {
  // Skip validation for taxonomy terms (allow emojis in labels).
  if ($entity->getEntityTypeId() === 'taxonomy_term') {
    return;
  }
  
  $violations = $entity->validate();
  
  foreach ($violations as $violation) {
    if ($violation->getConstraint() instanceof \Drupal\emoji_validation\Plugin\Validation\Constraint\NoEmojiConstraint) {
      throw new \Drupal\Core\Entity\EntityStorageException(
        t('Emoji characters are not allowed. Please remove them before saving.')
      );
    }
  }
}
