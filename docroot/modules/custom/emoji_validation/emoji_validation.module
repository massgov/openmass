<?php

/**
 * @file
 * Emoji validation module to prevent emoji characters in text fields.
 */

use Drupal\Core\Form\FormStateInterface;


/**
 * Returns the compiled emoji regex pattern (cached for performance).
 */
function _emoji_validation_get_pattern() {
  static $pattern = NULL;
  if ($pattern === NULL) {
    $pattern = '/[\x{1F600}-\x{1F64F}]|[\x{1F300}-\x{1F5FF}]|[\x{1F680}-\x{1F6FF}]|[\x{2600}-\x{26FF}]|[\x{2700}-\x{27BF}]|[\x{1F900}-\x{1F9FF}]|[\x{1FA70}-\x{1FAFF}]/u';
  }
  return $pattern;
}

/**
 * Implements hook_form_alter().
 */
function emoji_validation_form_alter(&$form, FormStateInterface $form_state, $form_id) {
  // Add emoji validation to all forms for text fields
  $form['#validate'][] = '_emoji_validation_validate_all_text_fields';
}


/**
 * Universal validation function that checks ALL text fields for emojis.
 */
function _emoji_validation_validate_all_text_fields(array &$form, FormStateInterface $form_state) {
  // Get all form values
  $values = $form_state->getValues();

  // Recursively check ALL form values for emojis
  _emoji_validation_check_all_values($form_state, $values, _emoji_validation_get_pattern(), []);
}

/**
 * Recursively checks ALL form values for emoji characters.
 */
function _emoji_validation_check_all_values(FormStateInterface $form_state, $values, $emoji_pattern, $field_path = []) {
  if (is_array($values)) {
    foreach ($values as $key => $value) {
      $current_path = array_merge($field_path, [$key]);

      if (is_string($value)) {
        // Check string values for emojis
        if (!empty($value) && preg_match($emoji_pattern, $value)) {
          $field_name = implode('][', $current_path);
          $form_state->setErrorByName($field_name, t('Emoji icons are not allowed in text fields. Please remove prior to saving.'));
        }
      }
      elseif (is_array($value)) {
        // Recursively check array values
        _emoji_validation_check_all_values($form_state, $value, $emoji_pattern, $current_path);
      }
    }
  }
  elseif (is_string($values)) {
    // Check single string values
    if (!empty($values) && preg_match($emoji_pattern, $values)) {
      $field_name = implode('][', $field_path);
      $form_state->setErrorByName($field_name, t('Emoji icons are not allowed in text fields. Please remove prior to saving.'));
    }
  }
}

/**
 * Implements hook_entity_presave().
 */
function emoji_validation_entity_presave($entity) {
  // Handle entity types (existing logic)
  emoji_validation_entity_presave_other($entity);
}


/**
 * Handles entity presave validation for non-file entities.
 *
 * ENHANCEMENT: This provides a secondary validation layer that checks
 * the actual entity data (not just form data) to catch cases where
 * existing content already contains emojis and the user tries to save
 * without making changes.
 */
function emoji_validation_entity_presave_other($entity) {
  // Check nodes, paragraphs, and taxonomy terms (for labels)
  if (!in_array($entity->getEntityTypeId(), ['node', 'paragraph', 'taxonomy_term'])) {
    return;
  }

  // Get the emoji pattern
  $emoji_pattern = _emoji_validation_get_pattern();

  $emoji_found = FALSE;
  $emoji_fields = [];

  // Special handling for taxonomy terms (labels)
  if ($entity->getEntityTypeId() === 'taxonomy_term') {
    // Check the taxonomy term name (label)
    $name = $entity->getName();
    if (!empty($name) && preg_match($emoji_pattern, $name)) {
      $emoji_found = TRUE;
      $emoji_fields[] = 'label name';
    }

    // Check taxonomy term description if it exists
    if ($entity->hasField('description') && !$entity->get('description')->isEmpty()) {
      $description = $entity->get('description')->value;
      if (!empty($description) && preg_match($emoji_pattern, $description)) {
        $emoji_found = TRUE;
        $emoji_fields[] = 'description';
      }
    }
  }
  else {
    // Check all text fields in other entity types
    $field_definitions = $entity->getFieldDefinitions();
    foreach ($field_definitions as $field_name => $field_definition) {
      if (in_array($field_definition->getType(), ['text', 'text_long', 'text_with_summary', 'string', 'string_long'])) {
        $field_value = $entity->get($field_name)->getValue();

        if (!empty($field_value)) {
          foreach ($field_value as $delta => $value) {
            if (isset($value['value']) && !empty($value['value']) && preg_match($emoji_pattern, $value['value'])) {
              $emoji_found = TRUE;
              $emoji_fields[] = $field_name;
            }
          }
        }
      }
    }
  }

  // If emojis found, prevent save and show error
  if ($emoji_found) {
    $entity_type = $entity->getEntityTypeId();
    $fields_list = implode(', ', $emoji_fields);

    if ($entity_type === 'taxonomy_term') {
      $error_message = t('This label contains emoji icons in the following fields: @fields. Please remove all emojis before saving.', [
        '@fields' => $fields_list,
      ]);
    }
    else {
      $error_message = t('This content contains emoji icons in the following fields: @fields. Please remove all emojis before saving.', [
        '@fields' => $fields_list,
      ]);
    }

    // Show user-friendly error message
    \Drupal::messenger()->addError($error_message);

    // Prevent the save by throwing a validation exception
    throw new \Drupal\Core\Entity\EntityStorageException($error_message);
  }
}
