<?php

declare(strict_types=1);

use Drupal\Core\Entity\EntityInterface;
use Drupal\Core\Entity\Display\EntityViewDisplayInterface;
use Drupal\node\NodeInterface;

/**
 * Implements hook_entity_view().
 */
function mass_form_context_entity_view(
  array &$build,
  EntityInterface $entity,
  EntityViewDisplayInterface $display,
  string $view_mode,
): void {
  if (!$entity instanceof NodeInterface) {
    return;
  }

  // Only act on the route node (avoid nested rendered nodes).
  $route_node = \Drupal::routeMatch()->getParameter('node');
  if ($route_node instanceof NodeInterface && $route_node->id() !== $entity->id()) {
    return;
  }

  $bundle = $entity->bundle();

  // Attach context tracking on any NON-form page.
  if ($bundle !== 'form_page') {
    $build['#attached']['library'][] = 'mass_form_context/page_context';
  }

  // Provide ignore list for both JS files (can be tweaked later).
  // Note: we also ignore anything starting with "utm_" in JS automatically.
  $build['#attached']['drupalSettings']['massFormContext']['ignoreKeys'] = [
    'gclid',
    'fbclid',
    'msclkid',
  ];

  // Form page iframe JS remains attached in twig template.
}
