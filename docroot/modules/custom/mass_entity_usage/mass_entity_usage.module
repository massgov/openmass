<?php

/**
 * @file
 * Contains mass_entity_usage.module.
 */

use Drupal\content_moderation\Entity\ContentModerationState;
use Drupal\content_moderation\Entity\ContentModerationStateInterface;
use Drupal\node\Entity\Node;

/**
 * Implements hook_entity_usage_block_tracking().
 */
function mass_entity_usage_entity_usage_block_tracking($target_id, $target_type, $source_id, $source_type, $source_langcode, $source_vid, $method, $field_name, $count) {
  if ($source_type == 'node') {
    // Load the node.
    $node = Node::load($source_id);
    // Get the moderation state.
    $content_moderation_state = ContentModerationState::loadFromModeratedEntity($node);
    if ($content_moderation_state instanceof ContentModerationStateInterface
      && !$content_moderation_state->get('moderation_state')->isEmpty()) {
      $state_name = $content_moderation_state->get('moderation_state')->value;
      // These states should be not be tracked.
      $skipped_states = [
        'unpublished',
        'trash',
      ];
      // Don't track sources that are in unpublished or trash state.
      if (in_array($state_name, $skipped_states)) {
        return TRUE;
      }
    }
  }
  return FALSE;
}
