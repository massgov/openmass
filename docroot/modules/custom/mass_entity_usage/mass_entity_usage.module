<?php

/**
 * @file
 * Contains mass_entity_usage.module.
 */

use Drupal\node\Entity\Node;

/**
 * Implements hook_entity_usage_block_tracking();
 */
function mass_entity_usage_entity_usage_block_tracking($target_id, $target_type, $source_id, $source_type, $source_langcode, $source_vid, $method, $field_name, $count) {
  if ($source_type == 'node') {
    // Load the node.
    $node = Node::load($source_id);
    // Get the moderation state.
    $current_state = node_revision_load($node->getRevisionId())
      ->get('moderation_state')
      ->getValue()[0]['value'];
    // These states should be not be tracked.
    $skipped_states = [
      'unpublished',
      'trash',
    ];
    // Don't track sources that are in unpublished or trash state.
    if (in_array($current_state, $skipped_states)) {
      return TRUE;
    }
  }
  return FALSE;
}
